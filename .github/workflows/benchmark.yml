name: Benchmark Runner

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]

jobs:
  run-benchmark:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}
        
    - name: Compile optimized
      run: g++ -std=c++17 -O3 main.cpp -o main
      
    - name: Run benchmark
      run: ./main
      
    - name: Save result to database
      run: |
        python3 -c "
        import json
        from leaderboard import save_to_db
        with open('result.json') as f:
            data = json.load(f)
        save_to_db('${{ github.actor }}', data)
        "
        
    - name: Commit and push database
      run: |
        git config user.name "github-actions"
        git config user.email "actions@users.noreply.github.com"
        git add leaderboard.db
        if [ -n "$(git status --porcelain)" ]; then
          git commit -m "ðŸ“Š Add benchmark result for ${{ github.actor }}"
          git push
        else
          echo "No changes to commit"
        fi
